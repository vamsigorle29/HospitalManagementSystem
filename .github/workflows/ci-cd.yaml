name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  detect-service:
    runs-on: ubuntu-latest
    outputs:
      service-name: ${{ steps.detect.outputs.service }}
      service-port: ${{ steps.detect.outputs.port }}
    steps:
      - uses: actions/checkout@v3
      - name: Detect service name
        id: detect
        run: |
          # Extract service name from repository name or directory structure
          REPO_NAME="${{ github.repository }}"
          SERVICE_NAME=$(echo "$REPO_NAME" | sed 's/.*\///' | sed 's/-service//')
          
          # Map service names to ports
          case "$SERVICE_NAME" in
            patient)
              PORT=8001
              ;;
            doctor)
              PORT=8002
              ;;
            billing)
              PORT=8003
              ;;
            appointment)
              PORT=8004
              ;;
            prescription)
              PORT=8005
              ;;
            payment)
              PORT=8006
              ;;
            notification)
              PORT=8007
              ;;
            *)
              PORT=8000
              ;;
          esac
          
          echo "service=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "Detected service: $SERVICE_NAME on port $PORT"

  test:
    runs-on: ubuntu-latest
    needs: detect-service
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test syntax
      run: |
        python -m py_compile app.py
        python -m py_compile models.py
        python -m py_compile database.py
        if [ -f "utils.py" ]; then
          python -m py_compile utils.py
        fi
    
    - name: Test imports
      run: |
        python -c "from app import app; print('App imports OK')"
        python -c "from models import *; print('Models imports OK')"
        python -c "from database import get_db; print('Database imports OK')"
    
    - name: Test health endpoint
      run: |
        python app.py &
        APP_PID=$!
        sleep 10
        PORT="${{ needs.detect-service.outputs.service-port }}"
        curl -f http://localhost:$PORT/health || exit 1
        echo "✅ Health check passed"
        kill $APP_PID || true

  build:
    runs-on: ubuntu-latest
    needs: [detect-service, test]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        SERVICE_NAME="${{ needs.detect-service.outputs.service-name }}"
        docker build -t ${SERVICE_NAME}-service:latest .
        docker images | grep ${SERVICE_NAME}-service
    
    - name: Test Docker image
      run: |
        SERVICE_NAME="${{ needs.detect-service.outputs.service-name }}"
        PORT="${{ needs.detect-service.outputs.service-port }}"
        
        echo "Testing Docker image: ${SERVICE_NAME}-service:latest on port $PORT"
        
        # Build environment variables based on service
        ENV_ARGS=""
        if [ "$SERVICE_NAME" = "appointment" ]; then
          ENV_ARGS="-e PATIENT_SERVICE_URL=http://localhost:8001 \
                    -e DOCTOR_SERVICE_URL=http://localhost:8002 \
                    -e BILLING_SERVICE_URL=http://localhost:8003 \
                    -e NOTIFICATION_SERVICE_URL=http://localhost:8007"
        fi
        
        # Run container
        docker run -d -p $PORT:$PORT $ENV_ARGS --name test-${SERVICE_NAME}-service ${SERVICE_NAME}-service:latest
        
        # Wait for service to be ready (increased timeout)
        echo "Waiting for service to start..."
        sleep 20
        
        # Retry health check with multiple attempts
        MAX_RETRIES=5
        RETRY_COUNT=0
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f http://localhost:$PORT/health; then
            echo "✅ Docker image works correctly"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed, retry $RETRY_COUNT/$MAX_RETRIES..."
            sleep 5
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "❌ Health check failed after $MAX_RETRIES attempts"
          docker logs test-${SERVICE_NAME}-service
          exit 1
        fi
        
        # Cleanup
        docker stop test-${SERVICE_NAME}-service || true
        docker rm test-${SERVICE_NAME}-service || true

